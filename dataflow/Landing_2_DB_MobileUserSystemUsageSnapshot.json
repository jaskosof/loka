{
	"name": "Landing_2_DB_MobileUserSystemUsageSnapshot",
	"properties": {
		"folder": {
			"name": "Facts"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "CMS_V2_DL_Landing_folder",
						"type": "DatasetReference"
					},
					"name": "UserListingViewExpanded"
				},
				{
					"dataset": {
						"referenceName": "CMS_V2_DL_folder",
						"type": "DatasetReference"
					},
					"name": "User"
				},
				{
					"dataset": {
						"referenceName": "CMS_V2_DL_folder",
						"type": "DatasetReference"
					},
					"name": "LeadMobileAppOpeningAudit"
				},
				{
					"dataset": {
						"referenceName": "CMS_V2_DL_folder",
						"type": "DatasetReference"
					},
					"name": "LeadMobileDevice"
				},
				{
					"dataset": {
						"referenceName": "AzureSQL_Insight_table",
						"type": "DatasetReference"
					},
					"name": "FactMobileUserSystemUsageSnapshot"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "AzureSQL_Insight_table",
						"type": "DatasetReference"
					},
					"name": "ListingViews"
				},
				{
					"dataset": {
						"referenceName": "AzureSQL_Insight_table",
						"type": "DatasetReference"
					},
					"name": "DeviceData"
				},
				{
					"dataset": {
						"referenceName": "AzureSQL_Insight_table",
						"type": "DatasetReference"
					},
					"name": "AppData"
				}
			],
			"transformations": [
				{
					"name": "SelectUserListingViewExpanded"
				},
				{
					"name": "FilterOnlySinceMobileAppLaunched",
					"description": "Load data from min date in LeadMobileAppOpeningAudit"
				},
				{
					"name": "SelectUser"
				},
				{
					"name": "DerivedColumnUserListingViewExpanded",
					"description": "Creates an explicit mapping for each drifted column"
				},
				{
					"name": "DerivedColumnLeadMobileLastOpeningAudit",
					"description": "Creates an explicit mapping for each drifted column"
				},
				{
					"name": "FirstAppOpenDate"
				},
				{
					"name": "DerivedColumnUser",
					"description": "Creates an explicit mapping for each drifted column"
				},
				{
					"name": "JoinFirstAppOpenDate"
				},
				{
					"name": "SelectMobileUsers"
				},
				{
					"name": "FilterWebUsers"
				},
				{
					"name": "FilterMobileUsers"
				},
				{
					"name": "CountOfMobileListings"
				},
				{
					"name": "CountOfWebListings"
				},
				{
					"name": "JoinWebAndMobileViews"
				},
				{
					"name": "JoinMobileUsers"
				},
				{
					"name": "AddFinalListingViews"
				},
				{
					"name": "SelectFinalListingViews"
				},
				{
					"name": "DerivedColumnsLeadMobileDevice",
					"description": "Creates an explicit mapping for each drifted column"
				},
				{
					"name": "SelectMobileDeviceData"
				},
				{
					"name": "SelectAppDate"
				},
				{
					"name": "MobileAppOpeningsPerDay"
				},
				{
					"name": "SelectLatestViewDate"
				},
				{
					"name": "DerivedColumnsFactMobileUserSystemUsageSnapshot",
					"description": "Creates an explicit mapping for each drifted column"
				},
				{
					"name": "JoinFactTable"
				},
				{
					"name": "AddFinalAppDataColumns"
				}
			],
			"script": "parameters{\n\tFolderName as string\n}\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tmoveFiles: [('CMS_V2_landing/' + $FolderName),('CMS_V2/' + $FolderName)],\n\tdocumentForm: 'documentPerLine') ~> UserListingViewExpanded\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tdocumentForm: 'documentPerLine') ~> User\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tdocumentForm: 'documentPerLine') ~> LeadMobileAppOpeningAudit\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tdocumentForm: 'documentPerLine') ~> LeadMobileDevice\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> FactMobileUserSystemUsageSnapshot\nDerivedColumnUserListingViewExpanded select(mapColumn(\n\t\tCreatedDateUTC,\n\t\tCreatedDateTimeUTC,\n\t\tSiteId,\n\t\tUserId,\n\t\tUserListingViewId,\n\t\tActivitySourceID,\n\t\tCookieId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectUserListingViewExpanded\nSelectUserListingViewExpanded filter(greaterOrEqual(toDate(toString(CreatedDateUTC), 'yyyy-MM-dd'), toDate('2019-11-15', 'yyyy-MM-dd'))) ~> FilterOnlySinceMobileAppLaunched\nDerivedColumnUser select(mapColumn(\n\t\tLeadId,\n\t\tSiteId,\n\t\tUserId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectUser\nUserListingViewExpanded derive(CompanyId = toString(byName('CompanyId')),\n\t\tCookieId = toString(byName('CookieId')),\n\t\tLastViewedDateUTC = toDate(left(toString(byName('LastViewed')), 10)),\n\t\tLastViewedDateTimeUTC = toTimestamp(replace(toString(byName('LastViewed')), 'T', ' ')),\n\t\tGclid = toString(byName('Gclid')),\n\t\tSiteId = toInteger(byName('SiteId')),\n\t\tUserId = toInteger(byName('UserId')),\n\t\tUserListingViewId = toString(byName('UserListingViewId')),\n\t\tActivitySourceID = toInteger(byName('ActivitySourceId')),\n\t\tCreatedDateUTC = toDate(left(toString(byName('CreatedDateTimeUTC')), 10)),\n\t\tCreatedDateTimeUTC = toTimestamp(replace(toString(byName('CreatedDateTimeUTC')), 'T', ' '))) ~> DerivedColumnUserListingViewExpanded\nLeadMobileAppOpeningAudit derive(Id = toInteger(byName('Id')),\n\t\tLeadId = toInteger(byName('LeadId')),\n\t\tMobileAppOpenDateUTC = toDate(left(toString(byName('OpenedAtUTC')), 10)),\n\t\tMobileAppOpenDateTimeUTC = toTimestamp(replace(toString(byName('OpenedAtUTC')), 'T', ' ')),\n\t\tPNSHandle = toString(byName('PNSHandle')),\n\t\tAppVersion = toString(byName('VersionOfHomeLocatorApp')),\n\t\tCookieId = toString(byName('CookieId'))) ~> DerivedColumnLeadMobileLastOpeningAudit\nDerivedColumnLeadMobileLastOpeningAudit aggregate(groupBy(LeadId),\n\tFirstMobileAppOpenDateUTC = min(MobileAppOpenDateUTC)) ~> FirstAppOpenDate\nUser derive(LeadId = toInteger(byName('LeadId')),\n\t\tSiteId = toInteger(byName('SiteId')),\n\t\tUserId = toInteger(byName('UserId'))) ~> DerivedColumnUser\nSelectUser, FirstAppOpenDate join(SelectUser@LeadId == FirstAppOpenDate@LeadId,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinFirstAppOpenDate\nJoinFirstAppOpenDate select(mapColumn(\n\t\tLeadId = SelectUser@LeadId,\n\t\tSiteId,\n\t\tUserId,\n\t\tLeadId = FirstAppOpenDate@LeadId,\n\t\tFirstMobileAppOpenDateUTC\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectMobileUsers\nJoinMobileUsers filter(equals(ActivitySourceID, 1)) ~> FilterWebUsers\nJoinMobileUsers filter(equals(ActivitySourceID, 2)) ~> FilterMobileUsers\nFilterMobileUsers aggregate(groupBy(SelectMobileUsers@SiteId,\n\t\tSelectMobileUsers@UserId,\n\t\tLeadId,\n\t\tCreatedDateUTC,\n\t\tCookieId),\n\tCountOfMobileViews = count(1),\n\t\tLastDailyView = max(CreatedDateTimeUTC)) ~> CountOfMobileListings\nFilterWebUsers aggregate(groupBy(SelectUserListingViewExpanded@SiteId,\n\t\tSelectUserListingViewExpanded@UserId,\n\t\tLeadId,\n\t\tCreatedDateUTC,\n\t\tCookieId),\n\tCountOfWebViews = count(1),\n\t\tLastDailyView = last(CreatedDateTimeUTC)) ~> CountOfWebListings\nCountOfMobileListings, CountOfWebListings join(CountOfMobileListings@UserId == CountOfWebListings@UserId\n\t&& CountOfMobileListings@CreatedDateUTC == CountOfWebListings@CreatedDateUTC\n\t&& CountOfMobileListings@CookieId == CountOfWebListings@CookieId,\n\tjoinType:'outer',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinWebAndMobileViews\nFilterOnlySinceMobileAppLaunched, SelectMobileUsers join(SelectUserListingViewExpanded@UserId == SelectMobileUsers@UserId\n\t&& CreatedDateUTC >= FirstMobileAppOpenDateUTC,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'right')~> JoinMobileUsers\nJoinWebAndMobileViews derive(SourceID = 1,\n\t\tVisitDateUTC = coalesce(CountOfMobileListings@CreatedDateUTC, CountOfWebListings@CreatedDateUTC),\n\t\tLeadID = coalesce(CountOfMobileListings@LeadId, CountOfWebListings@LeadId),\n\t\tUserID = coalesce(CountOfMobileListings@UserId, CountOfWebListings@UserId),\n\t\tCookieId = coalesce(CountOfMobileListings@CookieId, CountOfWebListings@CookieId)) ~> AddFinalListingViews\nAddFinalListingViews select(mapColumn(\n\t\tMobileSiteId = CountOfMobileListings@SiteId,\n\t\tCreatedDateUTC = CountOfMobileListings@CreatedDateUTC,\n\t\tCountOfMobileViews,\n\t\tLastDailyView = CountOfMobileListings@LastDailyView,\n\t\tWebSiteId = CountOfWebListings@SiteId,\n\t\tCreatedDateUTC = CountOfWebListings@CreatedDateUTC,\n\t\tCountOfWebViews,\n\t\tLastDailyView = CountOfWebListings@LastDailyView,\n\t\tSourceID,\n\t\tVisitDateUTC,\n\t\tLeadID = AddFinalListingViews@LeadID,\n\t\tUserID = AddFinalListingViews@UserID,\n\t\tCookieId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectFinalListingViews\nLeadMobileDevice derive(ID = toInteger(byName('Id')),\n\t\tLeadId = toInteger(byName('LeadId')),\n\t\tFirstOpenDateTime = toTimestamp(replace(toString(byName('FirstOpenDateTime')), 'T', ' ')),\n\t\tLastOpenDateTime = toTimestamp(replace(toString(byName('LastOpenDateTime')), 'T', ' ')),\n\t\tPNSHandle = toString(byName('PNSHandle')),\n\t\tPlatform = toString(byName('Platform')),\n\t\tManufacturer = toString(byName('Manufacturer')),\n\t\tModel = toString(byName('Model')),\n\t\tDeviceType = toString(byName('Idiom')),\n\t\tAppVersion = toString(byName('VersionOfHomeLocatorApp')),\n\t\tPermissionToSendNotifications = iif(toBoolean(byName('PermissionToSendNotifications')), 1, 0),\n\t\tPermissionToUseGPS = iif(toBoolean(byName('PermissionToUseGPS')), 1, 0),\n\t\tSourceID = 1,\n\t\tCookieId = toString(byName('CookieId'))) ~> DerivedColumnsLeadMobileDevice\nDerivedColumnsLeadMobileDevice select(mapColumn(\n\t\tID,\n\t\tLeadID = LeadId,\n\t\tFirstOpenDateTime,\n\t\tLastOpenDateTime,\n\t\tPNSHandle,\n\t\tPlatform,\n\t\tManufacturer,\n\t\tModel,\n\t\tDeviceType,\n\t\tAppVersion,\n\t\tPermissionToSendNotifications,\n\t\tPermissionToUseGPS,\n\t\tSourceID,\n\t\tCookieId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectMobileDeviceData\nAddFinalAppDataColumns select(mapColumn(\n\t\tSourceID,\n\t\tLeadID = LeadId,\n\t\tVisitDateUTC = MobileAppOpenDateUTC,\n\t\tPNSHandle,\n\t\tCookieId,\n\t\tAppVersion,\n\t\tNumberOfAppOpens\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectAppDate\nJoinFactTable aggregate(groupBy(LeadId,\n\t\tMobileAppOpenDateUTC,\n\t\tCookieId,\n\t\tPNSHandle,\n\t\tAppVersion),\n\tNumberOfAppOpens = count(1)) ~> MobileAppOpeningsPerDay\nDerivedColumnsFactMobileUserSystemUsageSnapshot aggregate(LatestViewDate = iifNull(max(VisitDateUTC), toDate('2019-11-15', 'yyyy-MM-dd'))) ~> SelectLatestViewDate\nFactMobileUserSystemUsageSnapshot derive(VisitDateUTC = toDate(byName('VisitDateUTC'))) ~> DerivedColumnsFactMobileUserSystemUsageSnapshot\nDerivedColumnLeadMobileLastOpeningAudit, SelectLatestViewDate join(MobileAppOpenDateUTC >= LatestViewDate,\n\tjoinType:'inner',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'right')~> JoinFactTable\nMobileAppOpeningsPerDay derive(SourceID = 1) ~> AddFinalAppDataColumns\nSelectFinalListingViews sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tSourceID,\n\t\tVisitDateUTC,\n\t\tUserID,\n\t\tLeadID,\n\t\tMobileSiteID = MobileSiteId,\n\t\tCountOfMobileViews,\n\t\tWebSiteID = WebSiteId,\n\t\tCountOfWebViews,\n\t\tCookieId\n\t)) ~> ListingViews\nSelectMobileDeviceData sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError') ~> DeviceData\nSelectAppDate sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tSourceID,\n\t\tLeadID,\n\t\tVisitDateUTC,\n\t\tPNSHandle,\n\t\tAppVersion,\n\t\tNumberOfAppOpens,\n\t\tCookieId\n\t)) ~> AppData"
		}
	}
}