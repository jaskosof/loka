{
	"name": "Landing_2_DB_UserSnapshot",
	"properties": {
		"folder": {
			"name": "Facts"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "CMS_V2_DL_Landing_folder",
						"type": "DatasetReference"
					},
					"name": "User"
				},
				{
					"dataset": {
						"referenceName": "SRC_DL_folder",
						"type": "DatasetReference"
					},
					"name": "Site"
				},
				{
					"dataset": {
						"referenceName": "SRC_DL_folder",
						"type": "DatasetReference"
					},
					"name": "Lead"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "AzureSQL_Insight_table",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "SelectUser"
				},
				{
					"name": "DerivedColumnUser",
					"description": "Creates an explicit mapping for each drifted column"
				},
				{
					"name": "Filter1",
					"description": "'DateCreatedUTC' > min(FactUserWebsiteActivitySnapshot.ViewedOn)"
				},
				{
					"name": "DerivedColumnSite"
				},
				{
					"name": "SelectSite"
				},
				{
					"name": "JoinSite"
				},
				{
					"name": "SelectLead"
				},
				{
					"name": "DerivedColumnLead"
				},
				{
					"name": "JoinLead"
				}
			],
			"script": "parameters{\n\tFolderName as string\n}\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tmoveFiles: [('CMS_V2_landing/' + $FolderName),('CMS_V2/' + $FolderName)],\n\tdocumentForm: 'documentPerLine') ~> User\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tdocumentForm: 'documentPerLine') ~> Site\nsource(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tdocumentForm: 'documentPerLine') ~> Lead\nDerivedColumnUser select(mapColumn(\n\t\tSourceID,\n\t\tLeadID,\n\t\tUserId,\n\t\tSiteId,\n\t\tDateCreatedUTC,\n\t\tGclid\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectUser\nUser derive(SourceID = 1,\n\t\tLeadID = toInteger(byName('LeadId')),\n\t\tUserId = toString(byName('UserId')),\n\t\tSiteId = toInteger(byName('SiteId')),\n\t\tDateCreatedUTC = toTimestamp(replace(toString(byName('DateCreatedUTC')), 'T', ' ')),\n\t\tGclid = toString(byName('Gclid'))) ~> DerivedColumnUser\nSelectUser filter(greaterOrEqual(toDate(toString(DateCreatedUTC), 'yyyy-MM-dd'), toDate('2020-06-05', 'yyyy-MM-dd'))) ~> Filter1\nSite derive(ServerId = toInteger(byName('ServerId')),\n\t\tSiteId = toInteger(byName('SiteId'))) ~> DerivedColumnSite\nDerivedColumnSite select(mapColumn(\n\t\tServerId,\n\t\tSiteId\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectSite\nFilter1, SelectSite join(SelectUser@SiteId == SelectSite@SiteId,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinSite\nDerivedColumnLead select(mapColumn(\n\t\tLeadID,\n\t\tLeadDateCreatedUTC,\n\t\tLeadImportActionID\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectLead\nLead derive(LeadID = toInteger(byName('ID')),\n\t\tLeadDateCreatedUTC = toTimestamp(replace(toString(byName('DateCreatedUTC')), 'T', ' ')),\n\t\tLeadImportActionID = toInteger(byName('LeadImportActionId'))) ~> DerivedColumnLead\nJoinSite, SelectLead join(SelectUser@LeadID == SelectLead@LeadID,\n\tjoinType:'left',\n\tmatchType:'exact',\n\tignoreSpaces: false,\n\tbroadcast: 'auto')~> JoinLead\nJoinLead sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tstagingSchemaName: 'import',\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tSourceID,\n\t\tUserID = UserId,\n\t\tLeadID = SelectLead@LeadID,\n\t\tSiteID = SelectUser@SiteId,\n\t\tDateCreatedUTC,\n\t\tServerID = ServerId,\n\t\tLeadDateCreatedUTC,\n\t\tLeadImportActionID,\n\t\tGclid\n\t)) ~> sink1"
		}
	}
}